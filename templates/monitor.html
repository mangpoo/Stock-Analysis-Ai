<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì›Œì»¤ ëª¨ë‹ˆí„°ë§</title>
    <style id="theme-style">
        /* ê¸°ë³¸: ë‹¤í¬ëª¨ë“œ */
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --bar-bg: #1f1f1f;
            --table-bg: #1e1e1e;
            --thead-bg: #2c2c2c;
            --border-color: #333;
        }

        body {
            margin: 0;
            font-family: sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .status-bar {
            background: var(--bar-bg);
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .status-bar span {
            margin-right: 30px;
            font-weight: bold;
        }

        .iframe-container {
            display: flex;
            width: 100vw;
            height: calc(100vh - 100px);
        }

        .iframe-container iframe {
            flex: 1;
            height: 100%;
            border: none;
        }

        h3 {
            color: var(--text-color);
            margin: 10px;
        }

        table {
            background-color: var(--table-bg);
            color: var(--text-color);
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--thead-bg);
        }

        td, th {
            border: 1px solid var(--border-color);
            padding: 5px;
        }

        .theme-toggle {
            margin: 10px;
            padding: 5px 10px;
            background-color: var(--thead-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <span id="total">ì´ ì›Œì»¤: ë¡œë”© ì¤‘...</span>
        <span id="active">í™œì„± ì›Œì»¤: ë¡œë”© ì¤‘...</span>
        <span id="pids">PID: ë¡œë”© ì¤‘...</span>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™/â˜€ï¸ ëª¨ë“œ ì „í™˜</button>
    </div>

    <div style="padding: 10px;">
        <h3>GPU ìƒíƒœ</h3>
        <table id="gpu-table">
            <thead>
                <tr>
                    <th>Device</th><th>Temp</th><th>Power</th><th>SCLK</th><th>MCLK</th><th>Fan</th><th>VRAM%</th><th>GPU%</th>
                </tr>
            </thead>
            <tbody id="gpu-body">
                <tr><td colspan="8">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="iframe-container">
        {% for port in ports %}
            <iframe src="http://minjun0410.iptime.org:{{ port }}"></iframe>
        {% endfor %}
    </div>

<script>
    let dark_state = localStorage.getItem("theme") === "dark";

    function sendThemeToIframes() {
        const iframes = document.querySelectorAll("iframe");
        iframes.forEach(iframe => {
            iframe.contentWindow.postMessage({ type: "theme", dark: dark_state }, "*");
        });
    }

    // iframe ë¡œë“œ í›„ í…Œë§ˆ ë©”ì‹œì§€ ì „ì†¡
    window.addEventListener("load", () => {
        setTimeout(sendThemeToIframes, 1000); // iframeì´ ë‹¤ ë¡œë“œë  ì‹œê°„ í™•ë³´
    });

    async function loadWorkerStatus() {
        try {
            const res = await fetch("/workers/status");
            const data = await res.json();
            document.getElementById("total").innerText = `ì´ ì›Œì»¤: ${data.total_workers}`;
            document.getElementById("active").innerText = `í™œì„± ì›Œì»¤: ${data.active_workers}`;
            document.getElementById("pids").innerText = `PID: ${data.worker_pids.join(', ')}`;
        } catch {
            document.getElementById("total").innerText = "ì´ ì›Œì»¤: ì˜¤ë¥˜";
            document.getElementById("active").innerText = "í™œì„± ì›Œì»¤: ì˜¤ë¥˜";
            document.getElementById("pids").innerText = "PID: ì˜¤ë¥˜";
        }
    }

    async function loadGpuStatus() {
        const tbody = document.getElementById("gpu-body");
        try {
            const res = await fetch("/gpu/status");
            const data = await res.json();

            if (data.error) {
                tbody.innerHTML = `<tr><td colspan="8">ì˜¤ë¥˜: ${data.error}</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            data.forEach(row => {
                tbody.innerHTML += `
                    <tr>
                        <td>${row.Device}</td>
                        <td>${row.Temp}</td>
                        <td>${row.Power}</td>
                        <td>${row.SCLK}</td>
                        <td>${row.MCLK}</td>
                        <td>${row.Fan}</td>
                        <td>${row["VRAM%"]}</td>
                        <td>${row["GPU%"]}</td>
                    </tr>`;
            });
        } catch {
            tbody.innerHTML = `<tr><td colspan="8">GPU ìƒíƒœ ë¡œë”© ì‹¤íŒ¨</td></tr>`;
        }
    }

    function toggleTheme() {
        const isDark = localStorage.getItem("theme") === "dark";
        const root = document.documentElement;
        const themeStyle = document.getElementById("theme-style");

        if (isDark) {
            dark_state = false;
            root.style.setProperty("--bg-color", "#ffffff");
            root.style.setProperty("--text-color", "#000000");
            root.style.setProperty("--bar-bg", "#eeeeee");
            root.style.setProperty("--table-bg", "#ffffff");
            root.style.setProperty("--thead-bg", "#dddddd");
            root.style.setProperty("--border-color", "#cccccc");
            localStorage.setItem("theme", "light");
        } else {
            dark_state = true;
            root.style.setProperty("--bg-color", "#121212");
            root.style.setProperty("--text-color", "#e0e0e0");
            root.style.setProperty("--bar-bg", "#1f1f1f");
            root.style.setProperty("--table-bg", "#1e1e1e");
            root.style.setProperty("--thead-bg", "#2c2c2c");
            root.style.setProperty("--border-color", "#333");
            localStorage.setItem("theme", "dark");
        }

        console.log(dark_state)
        sendThemeToIframes();
    }

    function applySavedTheme() {
        if (localStorage.getItem("theme") === "light") {
            toggleTheme(); // ê¸°ë³¸ì€ ë‹¤í¬ëª¨ë“œì´ë¯€ë¡œ ë¼ì´íŠ¸ì¼ ê²½ìš° ì „í™˜
        }
    }

    applySavedTheme();
    loadWorkerStatus();
    loadGpuStatus();

    // const darkMode = true; // ë˜ëŠ” false. ë™ì ìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ë„ ìˆìŒ.



    setInterval(loadGpuStatus, 2000);
    setInterval(loadWorkerStatus, 2000);

</script>

</body>
</html>
